<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0 gradient-text fade-down">Multi Mail Sender</h2>
    <div class="toolbar d-flex">
      <!-- Import/Export toolbar -->
      <button
        type="button"
        class="btn btn-outline-secondary btn-animate me-2"
        title="Import JSON"
        (click)="importInput.click()"
      >
        <i class="bi bi-download"></i> Import
      </button>
      <button
        type="button"
        class="btn btn-primary btn-animate"
        title="Export JSON"
        (click)="exportJson()"
      >
        <i class="bi bi-upload"></i> Export
      </button>
      <input
        #importInput
        type="file"
        accept="application/json,.json"
        class="d-none"
        (change)="onImportFileChange($event)"
      />
    </div>
  </div>

  <div class="mb-3 d-flex align-items-center">
    <label class="me-2 w-25">Email (Username)</label>
    <input
      type="email"
      class="form-control form-control-custom flex-grow-1"
      [(ngModel)]="request.username"
      placeholder="example@gmail.com"
    />
    <i
      class="bi bi-exclamation-circle-fill text-primary ms-2 info-icon"
      ngbTooltip="Your Gmail address. This is used to send emails."
      placement="right"
    ></i>
  </div>

  <div class="mb-3 d-flex align-items-center">
    <label class="me-2 w-25">App Password</label>
    <input
      type="password"
      class="form-control form-control-custom flex-grow-1"
      [(ngModel)]="request.password"
      placeholder="App Password"
    />
    <i
      class="bi bi-exclamation-circle-fill text-primary ms-2 info-icon"
      ngbTooltip="Create an App Password in your Google Account. It is different from your normal password."
      placement="right"
    ></i>
  </div>

  <div class="mb-3 d-flex align-items-center">
    <label class="me-2 w-25">Subject</label>
    <input
      type="text"
      class="form-control form-control-custom flex-grow-1"
      [(ngModel)]="request.subject"
      placeholder="Mail Subject"
    />
    <i
      class="bi bi-exclamation-circle-fill text-primary ms-2 info-icon"
      ngbTooltip="E-mail subject."
      placement="right"
    ></i>
  </div>

  <div class="mb-3 position-relative">
    <div class="d-flex align-items-start gap-3 flex-wrap">
      <label class="w-25" style="min-width: 200px">Body Draft</label>
      <textarea
        rows="5"
        class="form-control form-control-custom flex-grow-1"
        [(ngModel)]="request.bodydraft"
        placeholder="Dear {companyName}, ..."
      ></textarea>
    </div>
    <i
      class="bi bi-exclamation-circle-fill text-primary info-icon-textarea"
      ngbTooltip="Use placeholders like {companyName} and {companyNumber}. They will be replaced with actual values."
      placement="left"
    ></i>
  </div>

  <div class="d-flex justify-content-between align-items-center">
    <h5 class="mt-2 mb-2">Companies</h5>
    <div class="d-flex gap-2">
      <button
        class="btn btn-outline-danger btn-sm btn-animate"
        (click)="clearDatas()"
      >
        <i class="bi bi-trash"></i> Clear datas
      </button>
      <button
        class="btn btn-outline-primary btn-sm btn-animate"
        (click)="addCompany()"
      >
        <i class="bi bi-plus"></i> Add new company
      </button>
    </div>
  </div>

  <div
    *ngFor="let c of request.companyData; let i = index; trackBy: trackByIndex"
    class="card mb-3 animated-card"
  >
    <div
      class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
    >
      <div>Company {{ i | addOne }}</div>
      <button
        type="button"
        class="btn-close btn-close-white"
        aria-label="Close"
        (click)="removeCompany(i)"
      ></button>
    </div>
    <div class="card-body">
      <div class="mb-2">
        <label class="form-label">Company Mail</label>
        <input
          type="email"
          class="form-control form-control-custom"
          [(ngModel)]="c.companyMail"
          placeholder="company@example.com"
        />
      </div>

      <div
        class="mb-2"
        *ngFor="
          let entry of c.parameters | keyvalue;
          trackBy: trackByParamKey;
          let pi = index
        "
      >
        <div class="d-flex align-items-center gap-2">
          <label class="me-2" style="min-width: 120px">{{ entry.key }}</label>
          <input
            type="text"
            class="form-control form-control-custom"
            [(ngModel)]="c.parameters[entry.key]"
            placeholder="Parameter value"
          />
          <button
            type="button"
            class="btn btn-danger btn-sm btn-animate"
            (click)="removeParameter(c, entry.key)"
          >
            Delete
          </button>
        </div>
      </div>

      <button
        type="button"
        class="btn btn-secondary btn-sm btn-animate"
        (click)="addParameter(c)"
      >
        <i class="bi bi-plus"></i> New parameter
      </button>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">PDF Attachment</label>
    <input
      type="file"
      class="form-control form-control-custom"
      (change)="onFileSelected($event)"
      multiple
    />
    <div class="form-text">
      Attachments are not included in JSON export/import. Credentials (email &
      app password) are also excluded from Export.
    </div>
  </div>

  <div class="mb-4">
    <button class="btn btn-success w-100 btn-animate" (click)="sendMails()">
      Send Mails
    </button>
  </div>

  <div *ngIf="isSuccess === 0 && request.companyData.length" class="mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>Estimated time:</strong>
        ~{{ etaMinSeconds }} - {{ etaMaxSeconds }} seconds
      </div>
      <div><strong>Progress:</strong> {{ progress.length }}/{{ request.companyData.length }}</div>
    </div>
    <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
      <div
        class="progress-bar"
        [style.width]="(progress.length / request.companyData.length) * 100 + '%'"
      ></div>
    </div>
    <ul class="list-group mt-3">
      <li class="list-group-item" *ngFor="let p of progress">
        <span class="badge me-2" [ngClass]="p.status === 'sent' ? 'bg-success' : 'bg-danger'">
          {{ p.status }}
        </span>
        {{ p.companyMail }}
        <span class="text-muted" *ngIf="p.message">- {{ p.message }}</span>
      </li>
    </ul>
  </div>

  <ngb-alert
    *ngIf="responseMessage"
    [type]="isSuccess === 1 ? 'success' : isSuccess === -1 ? 'danger' : 'info'"
  >
    {{ responseMessage }}
  </ngb-alert>

  <div class="fixed-bottom d-flex align-items-center p-3 bg-light border-top">
    <div>
      <strong>Server Status:</strong>
      <span
        [ngClass]="
          serverStatus === 'Server is running' ? 'text-success' : 'text-danger'
        "
      >
        {{ serverStatus }}
      </span>
    </div>
    <button
      class="btn mx-3 btn-outline-info btn-animate"
      (click)="checkServer()"
    >
      Check Server Status
    </button>
  </div>
</div>
